{% extends "base.html" %}
{% block title %}Gruppe bearbeiten – UNDO{% endblock %}

{% block content %}
<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
  <a class="btn ghost" href="{{ url_for('group_open', group_id=group.id) }}">← Zurück</a>
  <div class="title">Gruppe bearbeiten</div>
</div>

<!-- === Gruppe bearbeiten === -->
<form method="post" class="card" style="max-width:740px;margin:0 auto">
  <div style="display:grid;gap:12px">
    <div>
      <label class="title" for="name">Name</label>
      <input id="name" name="name" type="text" value="{{ group.name or '' }}" style="margin-top:6px" required>
    </div>

    <div>
      <label class="title" for="motive">Gruppen-Motive (erforderlich)</label>
      <textarea id="motive" name="motive" rows="3" required>{{ group.motive or '' }}</textarea>
    </div>

    <div>
      <label class="title" for="chance">Gruppen-Chance / Ziel (erforderlich)</label>
      <textarea id="chance" name="chance" rows="3" required>{{ group.chance or '' }}</textarea>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:4px">
      <button class="btn" type="submit">Speichern</button>

      {% set invite = url_for('group_join', group_id=group.id, _external=True) %}
      <button class="btn ghost" type="button" onclick="shareInvite('{{ invite }}')">
        Mitglieder einladen
      </button>
    </div>
  </div>
</form>

<!-- === Mitglieder verwalten === -->
<div class="card" style="max-width:740px;margin:14px auto 0">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
    <div class="title">Mitglieder verwalten</div>
    <div class="muted">Owner kann Mitglieder entfernen</div>
  </div>

  <div style="margin-top:10px;display:flex;flex-direction:column;gap:10px">
    <!-- Owner-Zeile (ohne Entfernen) -->
    <div class="row" style="display:flex;align-items:center;gap:12px;justify-content:space-between;border-top:none">
      <div class="grow">
        <div style="font-weight:600">Owner</div>
        <div class="muted">Rolle: Owner</div>
      </div>
    </div>

    {% set uid_s = current_user.id|string %}
    {% set is_owner = (uid_s == (group.created_by|string)) %}
    {% set members_csv = (group.group_members or '').strip() %}
    {% set member_ids = members_csv.split(',') if members_csv else [] %}

    {% if member_ids|length == 0 %}
      <div class="muted">Noch keine weiteren Mitglieder.</div>
    {% else %}
      {% for mid in member_ids if mid|trim %}
        <div class="row" style="display:flex;align-items:center;gap:12px;justify-content:space-between">
          <div class="grow">
            <div style="font-weight:600">Benutzer #{{ mid }}</div>
            <div class="muted">Rolle: Member</div>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap">
            {% if is_owner %}
              <form method="post"
                    action="{{ url_for('group_member_remove', group_id=group.id, user_id=mid) }}"
                    onsubmit="return confirm('Mitglied wirklich entfernen?');">
                <button class="btn ghost" type="submit">Entfernen</button>
              </form>
            {% endif %}

            {% if (not is_owner) and (uid_s == mid) %}
              <form method="post"
                    action="{{ url_for('group_leave', group_id=group.id) }}"
                    onsubmit="return confirm('Gruppe verlassen?');">
                <button class="btn ghost" type="submit">Gruppe verlassen</button>
              </form>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

  <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
    <button class="btn" type="button" onclick="shareInvite('{{ invite }}')">Einladungslink teilen</button>
  </div>
</div>

<!-- Löschen (separates Formular, NICHT im Edit-Form verschachteln) -->
{% if current_user.is_authenticated and (current_user.id|string) == (group.created_by|string) %}
  <form method="post"
        action="{{ url_for('group_delete', group_id=group.id) }}"
        onsubmit="return confirm('Gruppe wirklich löschen?');"
        style="max-width:740px;margin:12px auto 0; text-align:right">
    <button class="btn ghost" type="submit">Gruppe löschen</button>
  </form>
{% endif %}

<style>
  .row .btn{white-space:nowrap}
  @media (max-width:640px){
    .row{flex-wrap:wrap}
    .row .grow{min-width:220px}
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  async function shareInvite(link) {
    try {
      if (navigator.share) {
        await navigator.share({
          title: 'Komm in meine UNDO Gruppe!',
          text: 'Hier ist dein Einladungslink:',
          url: link
        });
        return;
      }
    } catch (e) {
      console.warn('Native Share-API nicht verfügbar:', e);
    }
    try {
      await navigator.clipboard.writeText(link);
      alert('Einladungslink wurde in die Zwischenablage kopiert:\n' + link);
    } catch (e) {
      prompt('Teilen wird nicht unterstützt – kopiere den Link:', link);
    }
  }
</script>
{% endblock %}